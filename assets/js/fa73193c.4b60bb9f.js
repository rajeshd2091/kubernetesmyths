"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[3330],{6491:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>g,frontMatter:()=>a,metadata:()=>r,toc:()=>h});const r=JSON.parse('{"id":"k8s-core-myths/architecture-myths/Image_Garbage_collector_runs_only_when_disk_usage_crosses_a_High-Threshold","title":"Myth: Image Garbage collector runs only when disk usage crosses a High-Threshold","description":"During a node disk analysis in a long-running cluster, I noticed unused container images disappearing even though disk usage was well below the image GC high threshold.","source":"@site/docs/k8s-core-myths/architecture-myths/Image_Garbage_collector_runs_only_when_disk_usage_crosses_a_High-Threshold.md","sourceDirName":"k8s-core-myths/architecture-myths","slug":"/k8s-core-myths/architecture-myths/Image_Garbage_collector_runs_only_when_disk_usage_crosses_a_High-Threshold","permalink":"/k8s-core-myths/architecture-myths/Image_Garbage_collector_runs_only_when_disk_usage_crosses_a_High-Threshold","draft":false,"unlisted":false,"editUrl":"https://github.com/kubernetes-myths/website/blob/main/docs/k8s-core-myths/architecture-myths/Image_Garbage_collector_runs_only_when_disk_usage_crosses_a_High-Threshold.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"k8sCoreMythsSidebar","previous":{"title":"Myth: Image Garbage collector deletes images as soon as pods stop using them","permalink":"/k8s-core-myths/architecture-myths/Garbage_collector_deletes_images_as_soon_as_pods_stop_using_them"},"next":{"title":"Workload Myths","permalink":"/category/workload-myths"}}');var i=n(4848),t=n(8453);const a={sidebar_position:6},l="Myth: Image Garbage collector runs only when disk usage crosses a High-Threshold",o={},h=[{value:"Why This Myth Exists?",id:"why-this-myth-exists",level:3},{value:"The Reality",id:"the-reality",level:3},{value:"Source of Truth",id:"source-of-truth",level:3},{value:"Key Takeaways",id:"key-takeaways",level:3}];function c(e){const s={a:"a",code:"code",em:"em",h1:"h1",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"myth-image-garbage-collector-runs-only-when-disk-usage-crosses-a-high-threshold",children:"Myth: Image Garbage collector runs only when disk usage crosses a High-Threshold"})}),"\n",(0,i.jsxs)(s.p,{children:["During a node disk analysis in a long-running cluster, I noticed unused container images disappearing ",(0,i.jsx)(s.em,{children:"even though disk usage was well below the image GC high threshold."})]}),"\n",(0,i.jsx)(s.p,{children:"At first, this looked like a bug or a \u201cblack box\u201d behavior."}),"\n",(0,i.jsx)(s.p,{children:"A quick dive into the kubelet code told a different story."}),"\n",(0,i.jsx)(s.h3,{id:"why-this-myth-exists",children:"Why This Myth Exists?"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Most documentation emphasizes disk-pressure\u2013based GC."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Default kubelet settings ",(0,i.jsx)(s.strong,{children:"disable age-based image GC"}),", so it\u2019s rarely observed."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Engineers often equate image GC with ",(0,i.jsx)(s.code,{children:"imageGCHighThresholdPercent"})," only."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Kubernetes don\u2019t expose all kubelet flags clearly."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"the-reality",children:"The Reality"}),"\n",(0,i.jsx)(s.p,{children:"Kubernetes image garbage collection is not triggered only by disk pressure."}),"\n",(0,i.jsx)(s.p,{children:"Kubelet supports two image GC mechanisms:"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Disk pressure\u2013based GC"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Triggered when disk usage exceeds ",(0,i.jsx)(s.code,{children:"imageGCHighThresholdPercent"})]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Stops when usage drops below ",(0,i.jsx)(s.code,{children:"imageGCLowThresholdPercent"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Age-based GC (when enabled)"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Removes unused images older than ",(0,i.jsx)(s.code,{children:"imageMaximumGCAge"})]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Does not require disk pressure"}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Controlled by the ",(0,i.jsx)(s.code,{children:"ImageMaximumGCAge"})," feature gate"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"So images can be garbage-collected even when disk usage is healthy."}),"\n",(0,i.jsx)(s.p,{children:"Note:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:"This feature does not track image usage across kubelet restarts. If the kubelet is restarted, the tracked image age is reset, causing the kubelet to wait the full imageMaximumGCAge duration before qualifying images for garbage collection based on image age\n"})}),"\n",(0,i.jsx)(s.h3,{id:"source-of-truth",children:"Source of Truth"}),"\n",(0,i.jsx)(s.p,{children:"Kubernetes source code:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-go",children:'func (im *realImageGCManager) freeOldImages(ctx context.Context, images []evictionInfo, freeTime, beganGC time.Time) ([]evictionInfo, error) {\r\n\tif im.policy.MaxAge == 0 {\r\n\t\treturn images, nil\r\n\t}\r\n\r\n\t// Wait until the MaxAge has passed since the Kubelet has started,\r\n\t// or else we risk prematurely garbage collecting images.\r\n\tif freeTime.Sub(beganGC) <= im.policy.MaxAge {\r\n\t\treturn images, nil\r\n\t}\r\n\tvar deletionErrors []error\r\n\tlogger := klog.FromContext(ctx)\r\n\tremainingImages := make([]evictionInfo, 0)\r\n\tfor _, image := range images {\r\n\t\tlogger.V(5).Info("Evaluating image ID for possible garbage collection based on image age", "imageID", image.id)\r\n\t\t// Evaluate whether image is older than MaxAge.\r\n\t\tif freeTime.Sub(image.lastUsed) > im.policy.MaxAge {\r\n\t\t\tif err := im.freeImage(ctx, image, ImageGarbageCollectedTotalReasonAge); err != nil {\r\n\t\t\t\tdeletionErrors = append(deletionErrors, err)\r\n\t\t\t\tremainingImages = append(remainingImages, image)\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\t\t\tcontinue\r\n\t\t}\r\n\t\tremainingImages = append(remainingImages, image)\r\n\t}\r\n\tif len(deletionErrors) > 0 {\r\n\t\treturn remainingImages, fmt.Errorf("wanted to free images older than %v, encountered errors in image deletion: %v", im.policy.MaxAge, errors.NewAggregate(deletionErrors))\r\n\t}\r\n\treturn remainingImages, nil\r\n}\r\n\n'})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.a,{href:"https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/images/image_gc_manager.go#L425",children:"View Kubernetes Image GC Manager Source Code"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sh",children:"https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/images/image_gc_manager.go#L425\n"})}),"\n",(0,i.jsx)(s.h3,{id:"key-takeaways",children:"Key Takeaways"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Disk pressure is not the only trigger for image garbage collection"}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Age-based GC exists but is disabled by default"}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Long-running nodes can lose unused images even with plenty of disk space"}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Understanding kubelet internals prevents false assumptions during debugging"}),"\n"]}),"\n"]})]})}function g(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>l});var r=n(6540);const i={},t=r.createContext(i);function a(e){const s=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(t.Provider,{value:s},e.children)}}}]);